# 12306数据库逻辑 #

## 需求概述 #

业务: 查询，购票，退票、中转、改签、候补购票

数据结构: 车次、车票信息、座位号、购票人、订单信息、车站、支付信息、账目、出售的座位信息、线路、候补购票信息

## 数据结构 #

车次: 车次编号、座位数(物理)、座位数(线上)、商务座数、一等座数、二等座数、始发站、终点站、始发时间、终止时间

线路: 车次编号、始发站、终点站、途经车站(顺序)

座位数据: 车次编号、起始站、到达站、起始时间、到达时间、已出售商务座数、已出售一等座数、已出售二等座、允许发售时间

车票信息: 订单号、购票人信息、乘车人、出发时间、到达时间、出发地、目的地、车次、座位号、选座偏好、订餐、席位类别

购票人: 购票人信息(姓名、身份证号、性别)、历史订单编号、是否限制乘车、优惠状态(未成年、学生)

出售的座位信息: 车次编号、起始站、到达站、座位类别、座位号、乘车人、候补

车站: 车站名称、始发车次、终到车次、过站车次、车站等级(特等、12345等)

订单信息: 订单号、购票人、成交时间、车票信息、支付状态、支付信息

支付信息: 订单金额、聚合支付信息、是否更改、更改状态

账目: 订单号、订单金额、订单状态

候补购票信息: 候补单号、购票人、下单时间、车票信息、支付状态、支付信息、排位、截止时间

## 业务 #

车票信息 = 查询余票(出发地、目的地、出发日){
    车票信息 = 车次，过站，时间，价格，每种座位的余票数量。
}

购票: 购票分为订票和付款两个阶段，先出票(占座)再付款

(车票信息、订单信息) = 订票(订单信息){
    if 拒绝购票(订单信息)
        拒绝下单
    查询余票;
    选择可用的座位;
    车票信息 = 车次，时间，价格，座位号、席位类别、
    支付状态=0;
    根据优惠状态确定价格
    订单状态=待支付
    更新一次出票时所有原子区间的可用票数，用于判断下次是否能出票;
    维护所有已售出的票，用于为选择可用座位提供依据;
}

(车票信息、订单信息) = 支付(订单信息、支付信息){
    验证交易成功
    支付状态=1
    订单状态=完成
}

中转车票信息 = 查询中转((出发地、目的地、出发日){
    铁路有向图寻找最短路径(价格排序)
    铁路有向图寻找最短路径(时间排序)
}

(车票信息、订单信息) = 退票(订单号){
    车票注销
    订单状态=退票
    返还金额
    更新可用票数
    查询候补
}

订单信息 = 改签(订单信息、更新信息){
    判断允许改签
    更换订单信息
    更新可用票数
    查询候补

    计算差价
    支付状态=0
    更新支付信息: 是否更新(1)，更新状态(待退款/待补差价)
}

(候补购票信息) = 候补购票(购票人、下单时间、车票信息、截止时间){
    if 拒绝购票
        拒绝下单
    支付状态=0;
    根据优惠状态确定价格
    订单状态=待支付
    查询已有候补、确定排位
}

(候补购票信息) = 取消候补购票(候补购票信息){
    订单状态=取消候补购票
    退款
    更新候补排位
}

候补检查: 每日检查到期候补订单，取消之

## 细节 #

(余票数量: 根据订单信息，拿到出发地和目的地，获取这段区间里的所有的原子区间。尝试将每个原子区间的可用票数减1，如果所有的原子区间都够减，则有余票。)

某种座位的余票数量 = 余票数量(车次、席位类别、出发地、目的地、出发日){
    遍历(各区间):
        x(i) = 座位数据(车次、席位类别、出发日).(出票限制-各区间占用情况)*1(在允许发售时间)
    某种座位的余票数量 = min(x)
}

0/1 = 拒绝购票(订单信息){
    乘车人超过5个
    乘车人被限制乘车
    乘车人有同时间段其他车票
}
